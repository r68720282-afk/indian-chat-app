<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ChatRoom — ChatSystem</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#071024;
    --card: rgba(255,255,255,0.04);
    --glass: rgba(255,255,255,0.06);
    --accent:#4dc9ff;
    --muted:#bdbdbd;
  }
  html,body{height:100%;margin:0;font-family:"Poppins",sans-serif;background:linear-gradient(135deg,#071024,#0f1430);color:#fff}
  .app{display:flex;height:100vh;overflow:hidden}

  .sidebar{
    width:260px;background:var(--card);backdrop-filter:blur(12px);padding:18px;
    border-right:1px solid rgba(255,255,255,0.04);
    display:flex;flex-direction:column;gap:12px;
  }
  .brand{font-weight:700;font-size:20px;color:var(--accent);margin-bottom:6px}
  .userbox{font-size:14px;color:var(--muted);margin-bottom:8px}
  .rooms{flex:1;overflow:auto;padding-right:6px}
  .room-item{padding:12px;border-radius:10px;margin-bottom:8px;cursor:pointer;
    background:transparent;display:flex;justify-content:space-between;align-items:center}
  .room-item:hover{background:rgba(255,255,255,0.04);transform:translateX(4px)}
  .room-item.active{background:linear-gradient(90deg, rgba(77,201,255,0.14),
    rgba(168,87,247,0.06));box-shadow:0 6px 18px rgba(0,0,0,0.35)}
  .room-name{font-weight:600}
  .room-meta{font-size:12px;color:var(--muted)}
  .create-room{margin-top:auto}
  .small-btn{padding:8px 12px;border-radius:10px;border:none;background:transparent;
    color:var(--accent);cursor:pointer}

  .main{
    flex:1;display:flex;flex-direction:column;position:relative;
  }
  .main-header{display:flex;justify-content:space-between;align-items:center;
    padding:22px 26px;border-bottom:1px solid rgba(255,255,255,0.03);
    background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
  .room-title{font-size:20px;font-weight:700}
  .header-right{display:flex;align-items:center;gap:12px;color:var(--muted)}
  .status-dot{width:10px;height:10px;border-radius:50%;background:var(--accent);
    box-shadow:0 0 8px rgba(77,201,255,0.18)}

  .messages-wrap{flex:1;overflow:auto;padding:20px 26px;display:flex;
    flex-direction:column;gap:12px;}
  .msg{max-width:70%;padding:10px 12px;border-radius:12px;line-height:1.3;font-size:15px;word-break:break-word}
  .msg.me{align-self:flex-end;background:linear-gradient(90deg,#4dc9ff,#61d4ff);
    color:#000;border-bottom-right-radius:4px;box-shadow:0 6px 18px rgba(77,201,255,0.04)}
  .msg.other{align-self:flex-start;background:rgba(255,255,255,0.04);color:#fff;box-shadow:0 6px 12px rgba(0,0,0,0.04)}
  .msg .meta{font-size:12px;color:var(--muted);margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}
  .system-msg{align-self:center;background:transparent;color:var(--muted);font-size:13px;
    padding:6px 10px;border-radius:8px}

  .composer{display:flex;gap:10px;padding:16px;border-top:1px solid rgba(255,255,255,0.03);
    align-items:center;background:var(--glass)}
  .input{flex:1;padding:12px 14px;border-radius:12px;border:none;
    background:rgba(255,255,255,0.04);color:#fff;outline:none;font-size:15px;resize:none}
  .send-btn{padding:12px 18px;border-radius:12px;border:none;background:var(--accent);
    color:#000;font-weight:700;cursor:pointer}

  .users-panel{
    width:260px;background:var(--card);backdrop-filter:blur(12px);
    padding:18px;border-left:1px solid rgba(255,255,255,0.04);display:flex;flex-direction:column
  }
  .users-list{flex:1;overflow:auto;margin-top:10px}
  .user-row{padding:8px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02);
    display:flex;justify-content:space-between;align-items:center}

  @media (max-width:900px){
    .sidebar{display:none}
    .users-panel{display:none}
  }

  /* subtle fade animation class for appended messages */
  .fade-in {
    opacity: 0;
    transform: translateY(6px);
    transition: opacity .18s ease, transform .18s ease;
  }
  .fade-in.show {
    opacity: 1;
    transform: translateY(0);
  }
</style>
</head>
<body>

<div class="app">

  <aside class="sidebar">
    <div class="brand">ChatSystem</div>
    <div class="userbox" id="userBox">Hello</div>

    <div class="rooms" id="roomsList"></div>

    <div class="create-room">
      <button class="small-btn" onclick="location.href='/'">← Back</button>
    </div>
  </aside>

  <main class="main">
    <div class="main-header">
      <div>
        <div class="room-title" id="roomTitle">Loading…</div>
        <div class="room-sub" id="roomSub" style="font-size:13px;color:var(--muted)">Room description here</div>
      </div>
      <div class="header-right">
        <div class="status-dot"></div>
        <div id="onlineCount">0 online</div>
        <div id="toggleUsers" style="cursor:pointer;color:var(--accent)">Users</div>
      </div>
    </div>

    <div class="messages-wrap" id="messages"></div>

    <div class="composer">
      <!-- switched to a textarea-like input for multiline support later -->
      <textarea id="msgInput" class="input" placeholder="Type a message..." autocomplete="off" rows="1"></textarea>
      <button id="sendBtn" class="send-btn">Send</button>
    </div>
  </main>

  <aside class="users-panel" id="usersPanel">
    <div style="font-weight:700">Online Users</div>
    <div class="users-list" id="usersList"></div>
    <div style="font-size:13px;color:var(--muted);margin-top:10px">Owner token features coming</div>
  </aside>

</div>

<script src="/socket.io/socket.io.js"></script>
<script>
/* ---------- client side chat logic (updated timestamp + appendMessage) ---------- */

const socket = io();

function getQuery(n){return new URLSearchParams(location.search).get(n);}
const room = getQuery('room') || 'general';

let username = localStorage.getItem('chat_username') || '';
try {
  const p = JSON.parse(username);
  if (p.username) username = p.username;
} catch{}

if(!username){ location.href='/'; }

const messagesEl = document.getElementById('messages');
const sendBtn = document.getElementById('sendBtn');
const inputEl = document.getElementById('msgInput');
const roomTitle = document.getElementById('roomTitle');
const roomSub = document.getElementById('roomSub');
const userBox = document.getElementById('userBox');
const onlineCount = document.getElementById('onlineCount');
const usersListEl = document.getElementById('usersList');
const roomsListEl = document.getElementById('roomsList');
const usersPanel = document.getElementById('usersPanel');
const toggleUsers = document.getElementById('toggleUsers');

userBox.innerText = `You: ${username}`;

const rooms = {
  general:{ title:'General Chat', desc:'Public room for casual talk.' },
  tech:{ title:'Tech Talk', desc:'Discuss coding, AI, and gadgets.' },
  fun:{ title:'Fun Zone', desc:'Memes, jokes & fun.' },
  love:{ title:'Love Room', desc:'Friendly conversations & support.' },
  gaming:{ title:'Gaming Hub', desc:'Talk about games & teams.' }
};

Object.keys(rooms).forEach(rid=>{
  const div=document.createElement('div');
  div.className='room-item'+(rid===room?' active':'');
  div.innerHTML=`
    <div><div class="room-name">${rooms[rid].title}</div>
    <div class="room-meta">${rooms[rid].desc}</div></div>
    <div style="font-size:12px;color:var(--muted)">→</div>`;
  div.onclick=()=>location.href=`/chat.html?room=${rid}`;
  roomsListEl.appendChild(div);
});

function setRoomUI(r){
  const d=rooms[r]||{title:r,desc:''};
  roomTitle.innerText=d.title;
  roomSub.innerText=d.desc;
}
setRoomUI(room);

/* ---------------- Timestamp helpers & upgraded appendMessage ---------------- */

function isSameDay(a,b){
  return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
}
function isToday(d){
  return isSameDay(d, new Date());
}
function isYesterday(d){
  const y = new Date(); y.setDate(y.getDate()-1);
  return isSameDay(d, y);
}

function fmtTime(ts){
  const d = ts ? new Date(ts) : new Date();
  const time = d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  if (isToday(d)) return `${time}`;            // we'll show Today context in meta if needed
  if (isYesterday(d)) return `Yesterday • ${time}`;
  const shortDate = d.toLocaleDateString([], { year: 'numeric', month: 'short', day: 'numeric' });
  return `${shortDate} • ${time}`;
}

/* appendMessage: compact meta ("Name • time"), fade-in, smart scroll */
function appendMessage(m,isMe=false){
  const el = document.createElement('div');
  el.className = 'msg ' + (isMe ? 'me' : 'other');
  el.classList.add('fade-in');

  // meta row: name left, time right
  const meta = document.createElement('div');
  meta.className = 'meta';
  const nameDiv = document.createElement('div');
  nameDiv.style.fontWeight = '700';
  nameDiv.innerText = m.user || 'System';
  const timeDiv = document.createElement('div');
  timeDiv.style.fontSize = '12px';
  timeDiv.style.color = 'var(--muted)';
  timeDiv.innerText = fmtTime(m.ts || Date.now());
  meta.appendChild(nameDiv);
  meta.appendChild(timeDiv);

  // message text (preserve line breaks)
  const text = document.createElement('div');
  text.style.whiteSpace = 'pre-wrap';
  text.innerText = m.text || '';

  el.appendChild(meta);
  el.appendChild(text);

  messagesEl.appendChild(el);

  // force reflow then show
  requestAnimationFrame(()=> el.classList.add('show'));

  // SMART auto-scroll:
  // If user is near bottom (within 120px), auto scroll; else preserve position
  const threshold = 120;
  const isNearBottom = (messagesEl.scrollHeight - messagesEl.clientHeight - messagesEl.scrollTop) <= threshold;
  if (isNearBottom) {
    messagesEl.scrollTo({ top: messagesEl.scrollHeight, behavior: 'smooth' });
  }
}

/* system message */
function appendSystem(msg){
  const el=document.createElement('div');
  el.className='system-msg';
  el.innerText=msg;
  messagesEl.appendChild(el);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

/* ---------------- socket handlers ---------------- */

socket.on('connect',()=>{
  socket.emit('joinRoom',{roomId:room,username});
});

socket.on('recentMessages',list=>{
  messagesEl.innerHTML='';
  if(Array.isArray(list) && list.length){
    list.forEach(m=>appendMessage(m,m.user===username));
  } else appendSystem('No recent messages.');
});

socket.on('message',m=>{
  appendMessage(m,m.user===username);
});

socket.on('systemMessage',m=>{
  if(m && m.text) appendSystem(m.text);
});

// Users list handler (expects {count, list})
socket.on("roomUsers", (data) => {
  onlineCount.innerText = `${data.count} online`;
  usersListEl.innerHTML = "";
  (data.list || []).forEach((u) => {
    const row = document.createElement("div");
    row.className = "user-row";
    row.innerHTML = `
        <div>${u.name}</div>
        <div style="color:#4dc9ff; font-size:12px;">●</div>
    `;
    usersListEl.appendChild(row);
  });
});

/* ---------------- send / input handlers ---------------- */

// send message
function sendMessage(){
  const text = inputEl.value.trim();
  if(!text) return;

  // optimistic append
  appendMessage({user:username, text, ts: Date.now()}, true);

  socket.emit('sendMessage',{roomId:room, text});
  inputEl.value = '';
  // shrink textarea back to 1 row
  inputEl.style.height = 'auto';
}

// Enter = send, Shift+Enter = newline
inputEl.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

// autosize textarea (simple)
inputEl.addEventListener('input', () => {
  inputEl.style.height = 'auto';
  inputEl.style.height = (inputEl.scrollHeight) + 'px';
});

sendBtn.onclick = sendMessage;

toggleUsers.onclick=()=>{
  usersPanel.style.display = usersPanel.style.display==='none'?'flex':'none';
};

socket.on('disconnect',()=>{
  appendSystem('Disconnected — reconnecting...');
  document.querySelector('.status-dot').style.opacity='0.4';
});

socket.on('connect_error', err => {
  appendSystem('Connection error.');
});
</script>

<!-- DM POPUP FILES -->
<link rel="stylesheet" href="/dm.css">
<script src="/dm.js"></script>
<button onclick="openDM('Rohit')" 
style="position:fixed; top:20px; left:20px; z-index:9999;">
TEST DM
</button>

</body>
</html>

