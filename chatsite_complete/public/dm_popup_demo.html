<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chatsite-style DM Popups — Demo</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  /* === Theme variables (will be overridden by JS when user selects theme) === */
  :root{
    --bg: #0f1720;
    --panel: #ffffff; /* not used, but kept */
    --text: #e8eef6;
    --muted: #94a3b8;
    --border: rgba(255,255,255,0.06);
    --bubble-me: #4dc9ff;
    --bubble-them: rgba(255,255,255,0.04);
    --accent: #4dc9ff;
    --ui-bg: #0b1220;
  }

  /* Light theme */
  .theme-light {
    --bg: #f6f8fb;
    --ui-bg: #ffffff;
    --text: #0b1220;
    --muted: #6b7280;
    --border: rgba(12,14,20,0.08);
    --bubble-me: #0ea5a3;
    --bubble-them: #f1f5f9;
    --accent: #0ea5a3;
  }

  /* Blue theme */
  .theme-blue {
    --bg: #0b1a2b;
    --ui-bg: #071428;
    --text: #e6f3ff;
    --muted: #9fbcd7;
    --border: rgba(255,255,255,0.06);
    --bubble-me: #2ea6ff;
    --bubble-them: rgba(255,255,255,0.03);
    --accent: #2ea6ff;
  }

  html,body{height:100%;margin:0;font-family:'Poppins',sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
  .wrap { max-width:1200px;margin:28px auto;padding:18px; }

  header.top {
    display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;
  }
  .logo { font-weight:700;font-size:20px;color:var(--accent) }
  .profile {
    display:flex;align-items:center;gap:12px;
    background:var(--ui-bg);padding:8px;border-radius:10px;border:1px solid var(--border)
  }
  .profile select, .profile button { background:transparent;border:1px solid var(--border);color:var(--text);padding:6px 8px;border-radius:8px }
  .profile .small { font-size:12px;color:var(--muted);margin-left:8px }

  /* main area (left: online list, center: chat placeholder) */
  .main { display:flex;gap:18px }
  .col { background:var(--ui-bg); padding:14px; border-radius:10px; border:1px solid var(--border) }
  .left { width:260px; }
  .center { flex:1; min-height:420px; display:flex;align-items:center;justify-content:center; color:var(--muted); font-size:14px }

  .online-list { display:flex;flex-direction:column;gap:8px }
  .u { display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;cursor:pointer;border:1px solid transparent }
  .u:hover { background:rgba(255,255,255,0.02) }
  .avatar { width:38px;height:38px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#a86ef7);color:#041827;display:flex;align-items:center;justify-content:center;font-weight:700 }
  .uname { font-weight:600 }
  .umeta { font-size:12px;color:var(--muted) }

  /* DM popup container (chatsite-like flat style) */
  .dm-container { position:fixed; right:22px; bottom:22px; display:flex; flex-direction:row-reverse; gap:12px; z-index:1000 }
  .dm { width:340px; background:var(--ui-bg); color:var(--text); border:1px solid var(--border); border-radius:8px; overflow:hidden; display:flex;flex-direction:column; box-shadow:0 10px 30px rgba(2,6,23,0.6) }
  .dm + .dm { transform: translateX(-8px) } /* slight overlap feel */

  .dm-header { display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border);gap:8px }
  .dm-left { display:flex;align-items:center;gap:10px }
  .dm-title { display:flex;flex-direction:column }
  .dm-title .name { font-weight:700 }
  .dm-title .status { font-size:12px;color:var(--muted) }

  .dm-actions { display:flex;align-items:center;gap:6px }
  button.icon { background:transparent;border:0;padding:6px;border-radius:6px;cursor:pointer;color:var(--muted) }
  button.icon:hover { background:rgba(255,255,255,0.02); color:var(--accent) }

  .dm-body { padding:12px; height:260px; overflow:auto; display:flex;flex-direction:column; gap:10px; background:transparent }
  .bubble { max-width:78%; padding:8px 10px;border-radius:8px; font-size:14px; line-height:1.35; word-break:break-word; box-shadow: inset 0 -1px 0 rgba(255,255,255,0.01) }
  .bubble.them { background:var(--bubble-them); align-self:flex-start; color:var(--text) }
  .bubble.me { background:var(--bubble-me); color:#02121a; align-self:flex-end }

  .dm-footer { display:flex; gap:8px; padding:10px;border-top:1px solid var(--border); align-items:center }
  .dm-footer .txt { flex:1; border-radius:8px; border:1px solid var(--border); padding:8px 10px; background:transparent; color:var(--text); outline:none; min-height:36px; max-height:120px; resize:none }
  .dm-footer button.send { background:var(--accent); color:#02121a; border:0;padding:8px 12px;border-radius:8px; cursor:pointer }

  /* minimized bar (small rectangle) */
  .mini-bar { position:fixed; right:22px; bottom:22px; display:flex; gap:8px; align-items:center; z-index:800 }
  .mini-item { background:var(--ui-bg); border:1px solid var(--border); padding:8px 10px; border-radius:8px; display:flex; align-items:center; gap:8px; cursor:pointer }
  .mini-item .mavatar { width:34px;height:34px;border-radius:6px;background:linear-gradient(135deg,var(--accent),#a86ef7);display:flex;align-items:center;justify-content:center;color:#02121a;font-weight:700 }

  /* small helper */
  .muted { color:var(--muted) }
  .kbd { background:rgba(255,255,255,0.02); padding:3px 6px;border-radius:4px;font-size:12px;color:var(--muted); border:1px solid var(--border) }

  /* responsive: collapse popups on small screen to full width modal */
  @media (max-width:720px){
    .dm { width: calc(100% - 28px); right:14px; bottom:12px }
    .dm-container { left:50%; transform:translateX(-50%); bottom:12px; width:100%; justify-content:center }
  }
</style>
</head>
<body>
<div class="wrap" id="app">
  <header class="top">
    <div class="logo">ChatSite Mock — DM Demo</div>

    <div class="profile">
      <label class="muted" for="themeSelect">Theme:</label>
      <select id="themeSelect" aria-label="Choose theme">
        <option value="dark">Dark (default)</option>
        <option value="light">Light</option>
        <option value="blue">Blue</option>
      </select>

      <label class="muted" style="margin-left:8px">You:</label>
      <input id="usernameInput" placeholder="Your name" style="border:1px solid var(--border); background:transparent; color:var(--text); padding:6px 8px; border-radius:8px" />
      <select id="typeSelect" style="margin-left:6px;padding:6px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text)">
        <option value="user">Registered</option>
        <option value="guest">Guest</option>
      </select>
      <button id="saveProfile" style="margin-left:8px;padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text);cursor:pointer">Save</button>

      <div class="small muted" style="margin-left:10px">Theme persists per user</div>
    </div>
  </header>

  <div class="main">
    <aside class="col left">
      <h4 style="margin:0 0 10px 0">Online Users</h4>
      <div class="online-list" id="onlineList"></div>
    </aside>

    <section class="col center">
      <div style="text-align:center">
        <div style="font-size:18px;font-weight:700;margin-bottom:6px">Main Chat Area</div>
        <div class="muted">This demo focuses on DM popup style. Click any online user to open a private DM popup (no separate room URL).</div>
      </div>
    </section>
  </div>

  <!-- DM popups container -->
  <div id="dmContainer" class="dm-container" aria-live="polite"></div>
  <!-- minimized bar -->
  <div id="miniBar" class="mini-bar" style="display:none"></div>
</div>

<script>
/* ==========================
   Demo data + utilities
   ========================== */
const DB_USERS = [
  { name: 'Priya', id: 'p1' },
  { name: 'Rohit', id: 'r1' },
  { name: 'Aman', id: 'a1' },
  { name: 'Neha', id: 'n1' },
  { name: 'Vikas', id: 'v1' }
];

const app = document.getElementById('app');
const onlineList = document.getElementById('onlineList');
const dmContainer = document.getElementById('dmContainer');
const miniBar = document.getElementById('miniBar');

let openDMs = []; // array of {id, el, minimized}
let currentUser = { name: localStorage.getItem('chat_username') || 'You', type: localStorage.getItem('chat_usertype') || 'user' };

/* ==========================
   Theme system
   ========================== */
const themeSelect = document.getElementById('themeSelect');
function applyTheme(name){
  document.documentElement.classList.remove('theme-light','theme-blue');
  if(name === 'light') document.documentElement.classList.add('theme-light');
  if(name === 'blue') document.documentElement.classList.add('theme-blue');
  localStorage.setItem('chat_theme', name);
}
themeSelect.value = localStorage.getItem('chat_theme') || 'dark';
applyTheme(themeSelect.value);
themeSelect.addEventListener('change', ()=> applyTheme(themeSelect.value));

/* ==========================
   Profile save
   ========================== */
document.getElementById('usernameInput').value = currentUser.name;
document.getElementById('typeSelect').value = currentUser.type;
document.getElementById('saveProfile').addEventListener('click', ()=>{
  const nm = document.getElementById('usernameInput').value.trim() || 'You';
  const tp = document.getElementById('typeSelect').value;
  localStorage.setItem('chat_username', nm);
  localStorage.setItem('chat_usertype', tp);
  currentUser = { name: nm, type: tp };
  alert('Saved profile. Theme and name persisted locally for demo.');
});

/* ==========================
   Render online list
   ========================== */
function renderUsers(){
  onlineList.innerHTML = '';
  DB_USERS.forEach(u=>{
    const row = document.createElement('div');
    row.className = 'u';
    row.tabIndex = 0;
    row.innerHTML = `<div class="avatar">${u.name[0]}</div>
                     <div style="flex:1">
                       <div class="uname">${u.name}</div>
                       <div class="umeta">online • active</div>
                     </div>`;
    row.addEventListener('click', ()=> openDM(u));
    row.addEventListener('keydown', (e)=> { if(e.key === 'Enter') openDM(u); });
    onlineList.appendChild(row);
  })
}
renderUsers();

/* ==========================
   DM popup helpers
   ========================== */
function makeDMId(userA, userB){
  // deterministic id (no public room created; used to store messages server-side if needed)
  const arr = [userA.id || userA, userB.id || userB].sort();
  return 'dm_' + arr.join('_');
}

function openDM(user){
  const dmId = makeDMId({id:currentUser.name}, user);
  // if already open, focus it
  const found = openDMs.find(d => d.id === dmId);
  if(found){
    // bring it to front by re-append
    dmContainer.appendChild(found.el);
    return;
  }

  const el = document.createElement('div');
  el.className = 'dm';
  el.dataset.dm = dmId;
  el.innerHTML = dmTemplate(user);
  dmContainer.appendChild(el);

  // add to openDMs
  const dmObj = { id: dmId, el, minimized: false, user };
  openDMs.push(dmObj);

  wireDMEvents(dmObj);
  scrollDMToBottom(el);
}

/* DM HTML template (Chatsite-style flat) */
function dmTemplate(user){
  return `
    <div class="dm-header">
      <div class="dm-left">
        <div class="avatar" style="width:36px;height:36px;border-radius:6px">${user.name[0]}</div>
        <div class="dm-title">
          <div class="name">${user.name}</div>
          <div class="status muted">online • now</div>
        </div>
      </div>
      <div class="dm-actions">
        ${svgIcon('min','minimize')}
        ${svgIcon('max','maximize')}
        ${svgIcon('setting','setting')}
        ${svgIcon('close','close')}
      </div>
    </div>
    <div class="dm-body" role="log" aria-live="polite">
      <div class="bubble them"><div class="muted">${user.name} • 6:02 PM</div>Hey! this is a private chat demo.</div>
      <div class="bubble me"><div class="muted">You • 6:03 PM</div>Nice — DM popup looks clean.</div>
    </div>
    <div class="dm-footer">
      <div contenteditable="true" class="txt" data-placeholder="Type a private message..."></div>
      <button class="send">Send</button>
    </div>
  `;
}

/* attach event handlers inside a dm */
function wireDMEvents(dmObj){
  const el = dmObj.el;
  const header = el.querySelector('.dm-header');
  const body = el.querySelector('.dm-body');
  const txt = el.querySelector('.txt');
  const send = el.querySelector('.send');

  // tool buttons
  header.querySelector('[data-act="min"]').addEventListener('click', ()=>{
    minimizeDM(dmObj);
  });
  header.querySelector('[data-act="max"]').addEventListener('click', ()=>{
    toggleMax(dmObj);
  });
  header.querySelector('[data-act="setting"]').addEventListener('click', (e)=>{
    // settings menu simple: show browser prompt for demo (you'll replace with dropdown)
    e.stopPropagation();
    const choice = prompt('Action for ' + dmObj.user.name + ' (report / ignore / block)?','report');
    if(choice) alert('Demo action: '+choice);
  });
  header.querySelector('[data-act="close"]').addEventListener('click', ()=>{
    closeDM(dmObj);
  });

  send.addEventListener('click', ()=> {
    sendDMMessage(dmObj, txt.innerText.trim());
    txt.innerText = '';
  });

  // Enter to send, Shift+Enter newline
  txt.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      send.click();
    }
  });

  // click on body focuses input
  body.addEventListener('click', ()=> txt.focus());
}

/* minimize: hide popup and add to miniBar */
function minimizeDM(dmObj){
  dmObj.el.style.display = 'none';
  dmObj.minimized = true;
  // add mini item
  const item = document.createElement('div');
  item.className = 'mini-item';
  item.dataset.dm = dmObj.id;
  item.innerHTML = `<div class="mavatar">${dmObj.user.name[0]}</div><div><div style="font-weight:700">${dmObj.user.name}</div><div class="muted" style="font-size:12px">minimized</div></div>`;
  item.addEventListener('click', ()=>{
    // restore
    dmObj.el.style.display = 'flex';
    dmObj.minimized = false;
    item.remove();
    if(miniBar.children.length === 0) miniBar.style.display = 'none';
  });
  miniBar.appendChild(item);
  miniBar.style.display = 'flex';
}

/* close dm */
function closeDM(dmObj){
  dmObj.el.remove();
  // remove from openDMs
  openDMs = openDMs.filter(d => d.id !== dmObj.id);
  // remove minimized item if exists
  const existingMini = Array.from(miniBar.children).find(n => n.dataset.dm === dmObj.id);
  if(existingMini) existingMini.remove();
  if(miniBar.children.length === 0) miniBar.style.display = 'none';
}

/* toggle half/full widths (just toggles a class on element for demo) */
function toggleMax(dmObj){
  const el = dmObj.el;
  if(el.classList.contains('full')){
    el.classList.remove('full');
    el.style.width = ''; // reset
  } else {
    el.classList.add('full');
    // move it to center if wide
  }
}

/* send message: append bubble (optimistic); replace with real socket emit later */
function sendDMMessage(dmObj, text){
  if(!text) return;
  const body = dmObj.el.querySelector('.dm-body');
  const b = document.createElement('div');
  b.className = 'bubble me';
  b.innerHTML = `<div class="muted">You • ${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>${escapeHTML(text)}`;
  body.appendChild(b);
  body.scrollTop = body.scrollHeight;
  // simulate reply
  setTimeout(()=> {
    const r = document.createElement('div');
    r.className = 'bubble them';
    r.innerHTML = `<div class="muted">${dmObj.user.name} • ${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>Auto reply — received: ${escapeHTML(text.substring(0,60))}`;
    body.appendChild(r);
    body.scrollTop = body.scrollHeight;
  }, 900);
}

/* scroll helper */
function scrollDMToBottom(el){
  const body = el.querySelector('.dm-body');
  setTimeout(()=> body.scrollTop = body.scrollHeight, 60);
}

/* escape html */
function escapeHTML(s){ return String(s).replace(/[&<>"']/g, (m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* svg icons (thin outline style) */
function svgIcon(name, title){
  const svgs = {
    min: '<button class="icon" data-act="min" title="'+title+'" aria-label="'+title+'">'+
         '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>',
    max: '<button class="icon" data-act="max" title="'+title+'" aria-label="'+title+'">'+
         '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"></rect></svg></button>',
    setting: '<button class="icon" data-act="setting" title="'+title+'" aria-label="'+title+'">'+
             '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"></path><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06A2 2 0 1 1 2.3 17.9l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09c.66 0 1.23-.4 1.48-1 .18-.39.18-.83 0-1.22A1.65 1.65 0 0 0 3.39 6.2L3.33 6.14A2 2 0 1 1 6.2 3.3l.06.06c.4.18.83.18 1.22 0 .6-.25 1-.82 1-1.48V3c0-1.1.9-2 2-2h0c1.1 0 2 .9 2 2v.09c0 .66.4 1.23 1 1.48.39.18.83.18 1.22 0 .6-.25 1-.82 1-1.48V3c1.1 0 2 .9 2 2v.09c0 .66.4 1.23 1 1.48.39.18.83.18 1.22 0 .6-.25 1-.82 1-1.48V3"></path></svg></button>',
    close: '<button class="icon" data-act="close" title="'+title+'" aria-label="'+title+'">'+
           '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>'
  };
  return svgs[name] || '';
}

/* On load, restore username & type from localStorage */
(function init(){
  const name = localStorage.getItem('chat_username');
  const type = localStorage.getItem('chat_usertype');
  if(name) {
    document.getElementById('usernameInput').value = name;
    currentUser.name = name;
  }
  if(type) {
    document.getElementById('typeSelect').value = type;
    currentUser.type = type;
  }
})();

</script>
</body>
</html>
